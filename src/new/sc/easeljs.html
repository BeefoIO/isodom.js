<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>isodom.js City Example</title>
    <style>
        html, body {
            margin: 0;
            overflow: hidden;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100%;
            border: 2px solid grey;
            overflow: auto;
        }

        #items {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<canvas id="grid"></canvas>
<canvas id="items"></canvas>

<p>Assets by: <a href="http://kenney.nl/assets?s=isometric">Kenney.nl</a></p>

<script src="easeljs.mod.js"></script>
<script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>
<script src="../IsoDom.js" type="application/javascript"></script>
<script src="../conductors/easeljs/Conductor.js" type="application/javascript"></script>
<script>
    /** @type {IsoDomItem} */
    let moving = null;
    let debug = null;
    let debugStart = null;
    let preload = new createjs.LoadQueue();
    preload.addEventListener('complete', () => {

        const conductor = new IsoDomEaselJsConductor({
            gridTarget: document.getElementById('grid'),
            itemsTarget: document.getElementById('items'),
            image: preload.getResult('cell'),
            resolve(src) {
                return preload.getResult(src);
            },
            offsetPivot: 'bottom-right',
        });

        window.iso = new IsoDom(conductor, {
            debug: true,
            columns: 20,
            rows: 20,
            cellSize: [244, 144],
            items: {
                desk1: {
                    orientation: IsoDom.ORIENTATION_SE,
                    size: [2, 2],
                    images: {
                        [IsoDom.ORIENTATION_NW]: { url: 'desk1-1', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_NE]: { url: 'desk1-2', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_SE]: { url: 'desk1-3', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_SW]: { url: 'desk1-4', offset: { top: 103, left: 39 } },
                    },
                },
                meeting_table1: {
                    orientation: IsoDom.ORIENTATION_SE,
                    size: [6, 3],
                    images: {
                        [IsoDom.ORIENTATION_NE]: { url: 'meeting_table1-1', offset: { top: -0, left: -0 } },
                        [IsoDom.ORIENTATION_NW]: { url: 'meeting_table1-2', offset: { top: -0, left: -0 } },
                        [IsoDom.ORIENTATION_SW]: { url: 'meeting_table1-4', offset: { top: 286, left: 379 } },
                        [IsoDom.ORIENTATION_SE]: { url: 'meeting_table1-3', offset: { top: -0, left: -0 } },
                    },
                },
            },
            events: {
                cellCreated(cell) {
                    cell.meta.displayObject.addEventListener('mouseover', () => {
                        console.log('cell: mouseover');
                        if (moving) {
                            iso.conductor.updateItemPosition(moving, cell);
                        }
                    });
                    cell.meta.displayObject.addEventListener('click', () => {
                        console.log('cell: click');
                        if (moving) {
                            moving.iso.moveItem(moving, cell.x, cell.y);
                            moving.iso.draw();
                            moving.iso.conductor.config.itemsTarget.style.pointerEvents = '';
                            moving.iso.conductor.itemsStage.mouseEnabled = true;
                            moving = null;
                        }
                    });
                },

                itemAdded(item) {
                    const sprite = new createjs.SpriteSheet({
                        images: [preload.getResult('coin-sprite')],
                        frames: {
                            width: 57.14285714285714,
                            height: 57,
                        },
                        animations: {
                            spin: {
                                frames: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],
                                speed: 0.35,
                            },
                        },
                    });
                    const animation = new createjs.Sprite(sprite);
                    animation.gotoAndPlay('spin');
                    item.meta.displayObject.addChild(animation);

                    item.meta.displayObject.addEventListener('mouseover', () => {
                        console.log('item: mouseover');
                        if (debug) {
                            return;
                        }

                        item.meta.displayObject.children[0].filters = [
                            new createjs.ColorFilter(1, 1, 1, 1, 10, 10, 10, 0),
                        ];
                        item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                    });
                    item.meta.displayObject.addEventListener('mouseout', () => {
                        console.log('item: mouseclick');
                        if (debug) {
                            return;
                        }

                        item.meta.displayObject.children[0].filters = [
                            new createjs.ColorFilter(1, 1, 1, 1, 0, 0, 0, 0),
                        ];
                        item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                    });
                    item.meta.displayObject.addEventListener('click', (e) => {
                        console.log('item: click');
                        if (e.nativeEvent.button === 0) {
                            if (dragging.active) return;
                            item.iso.conductor.config.itemsTarget.style.pointerEvents = 'none';
                            item.iso.conductor.itemsStage.mouseEnabled = false;
                            moving = item;
                        } else if (e.nativeEvent.button === 2) {
                            item.iso.conductor.config.itemsTarget.style.pointerEvents = 'none';
                            item.meta.displayObject.children[0].filters = [
                                new createjs.ColorFilter(1, 1, 1, 1, 100, 0, 0, 100),
                            ];
                            item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                            debug = item;
                            const imageOffset = item.image().offset;
                            debugStart = { top: Number(item.meta.displayObject.y) - imageOffset.top, left: Number(item.meta.displayObject.x) - imageOffset.left };
                        }
                    });
                },
            },
        });

        //iso.conductor.gridStage.enableMouseOver(20);
        iso.conductor.itemsStage.enableMouseOver(20);

        // Adding example desks
        for (let row = 0; row < iso.config.rows-3; row = row+4) {
            for (let col = 0; col < iso.config.columns-3; col = col+4) {
                iso.addItem('desk1', col, row, { orientation: IsoDom.ORIENTATION_SW });
            }
        }

        iso.draw();

        // Add background
        iso.background = new createjs.Bitmap(preload.getResult('expensiveBuilding'));
        iso.background.setBounds(0,0, 6144, 3840); // Set bounds manually to allow for SPOT compatible image
        iso.conductor.itemsStage.addChild(iso.background);
        iso.background.x = -900;
        iso.background.y = -700;
        iso.conductor.itemsStage.setChildIndex(iso.background, 0);

        // Set scale
        let backgroundBounds = iso.background.getBounds();
        iso.minimumScale = Math.ceil(Math.max(
            (window.innerHeight * 100 / (backgroundBounds.height + iso.background.y)),
            (window.innerWidth * 100 / (backgroundBounds.width + iso.background.x))
        )) / 100;

        iso.conductor.gridStage.scale = iso.minimumScale;
        iso.conductor.itemsStage.scale = iso.minimumScale;


        // Setup mouse panning
        let dragging = { mousePressed: false, active: false, startX: 0, startY: 0, endX: 0, endY: 0 };
        iso.conductor.itemsStage.on('stagemouseup', function(event) {
            dragging.mousePressed = false;
            setTimeout(() => {
                dragging.active = false;
            }, 10);
        });
        iso.conductor.itemsStage.on('stagemousedown', function(event) {
            dragging.mousePressed = true;
            dragging.startX = event.stageX;
            dragging.startY = event.stageY;
        });
        iso.conductor.itemsStage.on('stagemousemove', function(event) {
            if(!dragging.mousePressed) return;

            dragging.endX = event.stageX;
            dragging.endY = event.stageY;

            let xDiff = dragging.endX - dragging.startX;
            let yDiff = dragging.endY - dragging.startY;

            if (Math.abs(xDiff) > 3 && Math.abs(yDiff) > 3 && !dragging.active) {
                dragging.active = true;
            }

            if (dragging.active) {
                console.log(`The diff is: X: ${ xDiff } Y: ${ yDiff }`);

                const scale = iso.conductor.itemsStage.scale;

                // Figure out if we should stop moving because of out-of-bounds
                let backgroundBounds = iso.background.getBounds();

                let minX = iso.conductor.config.itemsTarget.width - (backgroundBounds.width * scale) - (iso.background.x * scale);
                let maxX = Math.abs(iso.background.x) * scale;

                let minY = iso.conductor.config.itemsTarget.height - (backgroundBounds.height * scale) - (iso.background.y * scale);
                let maxY = Math.abs(iso.background.y) * scale;

                let newX = iso.conductor.itemsStage.x + xDiff;
                let newY = iso.conductor.itemsStage.y + yDiff;

                // Handle X
                if ((newX * scale) > (minX * scale) && (newX * scale) < (maxX * scale)) {
                    iso.conductor.itemsStage.x = newX;
                    iso.conductor.gridStage.x = newX;
                }

                // Handle Y
                if ((newY * scale) > (minY * scale) && (newY * scale) < (maxY * scale)) {
                    iso.conductor.itemsStage.y = newY;
                    iso.conductor.gridStage.y = newY;
                }

                dragging.startX = event.stageX;
                dragging.startY = event.stageY;

               console.log('mouse move!');
            }
        });

        debug = true;
        document.addEventListener('keydown', (e) => {
            if (!debug) {
                return;
            }

            let mod = 1;
            if (e.shiftKey) {
                mod = 10;
            }

            let wasdStepSize = 10;

            switch (e.code) {
                case 'ArrowUp':
                    debug.meta.displayObject.y -= mod;
                    e.preventDefault();
                    break;

                case 'ArrowDown':
                    debug.meta.displayObject.y += mod;
                    e.preventDefault();
                    break;

                case 'ArrowLeft':
                    debug.meta.displayObject.x -= mod;
                    e.preventDefault();
                    break;

                case 'ArrowRight':
                    debug.meta.displayObject.x += mod;
                    e.preventDefault();
                    break;

                case 'Enter':
                    const pivots = iso.conductor.config.offsetPivot.split('-');
                    const output = {
                        top: debugStart.top - Number(debug.meta.displayObject.y),
                        left: debugStart.left - Number(debug.meta.displayObject.x),
                    };
                    if (pivots.includes('bottom')) {
                        output.top *= -1;
                    }
                    if (pivots.includes('right')) {
                        output.left *= -1;
                    }
                    console.log(debug.orientation, output);
                    debug.meta.displayObject.filters = [];
                    debug.meta.displayObject.cache(0, 0, debug.meta.displayObject.image.width, debug.meta.displayObject.image.height);
                    debug = null;
                    debugStart = null;
                    iso.draw();
                    iso.conductor.config.itemsTarget.style.pointerEvents = '';
                    e.preventDefault();
                    break;
                case 'KeyW':
                    iso.conductor.itemsStage.y += wasdStepSize;
                    iso.conductor.gridStage.y += wasdStepSize;
                    break;
                case 'KeyA':
                    iso.conductor.itemsStage.x += wasdStepSize;
                    iso.conductor.gridStage.x += wasdStepSize;
                    break;
                case 'KeyS':
                    iso.conductor.itemsStage.y -= wasdStepSize;
                    iso.conductor.gridStage.y -= wasdStepSize;
                    break;
                case 'KeyD':
                    iso.conductor.itemsStage.x -= wasdStepSize;
                    iso.conductor.gridStage.x -= wasdStepSize;
                    break;
            }

            // iso.conductor.itemsStage.update();
        });

        document.addEventListener('wheel', e => {
            let isScrollDown = e.deltaY > 0;

            if (isScrollDown) {
                if (iso.minimumScale < iso.conductor.itemsStage.scale-0.1) {
                    iso.conductor.itemsStage.scale -= 0.1;
                    iso.conductor.gridStage.scale -= 0.1;
                }
            } else {
                if (iso.conductor.itemsStage.scale < 0.9) {
                    iso.conductor.itemsStage.scale += 0.1;
                    iso.conductor.gridStage.scale += 0.1;
                }
            }
        });
    });
    preload.loadManifest([
        { src: 'assets/cell.png', id: 'cell' },
        { src: 'assets/coin-sprite.png', id: 'coin-sprite' },
        { src: 'assets/desk1-1.png', id: 'desk1-1' },
        { src: 'assets/desk1-2.png', id: 'desk1-2' },
        { src: 'assets/desk1-3.png', id: 'desk1-3' },
        { src: 'assets/desk1-4.png', id: 'desk1-4' },
        { src: 'assets/meeting_table1-1.png', id: 'meeting_table1-1' },
        { src: 'assets/meeting_table1-2.png', id: 'meeting_table1-2' },
        { src: 'assets/meeting_table1-3.png', id: 'meeting_table1-3' },
        { src: 'assets/meeting_table1-4.png', id: 'meeting_table1-4' },
        { src: 'assets/expensiveBuilding.webp', id: 'expensiveBuilding' },
    ]);
</script>
</body>
</html>
