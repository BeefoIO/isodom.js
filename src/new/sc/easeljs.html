<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>isodom.js City Example</title>
    <style>
        #container {
            position: relative;
            width: 100%;
            height: 100%;
            border: 2px solid grey;
            overflow: auto;
        }

        #items {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<div id="container">
    <canvas id="grid"></canvas>
    <canvas id="items"></canvas>
</div>

<p>Assets by: <a href="http://kenney.nl/assets?s=isometric">Kenney.nl</a></p>

<script src="easeljs.mod.js"></script>
<script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>
<script src="../IsoDom.js" type="application/javascript"></script>
<script src="../conductors/easeljs/Conductor.js" type="application/javascript"></script>
<script>
    /** @type {IsoDomItem} */
    let moving = null;
    let debug = null;
    let debugStart = null;
    let preload = new createjs.LoadQueue();
    preload.addEventListener('complete', () => {

        const conductor = new IsoDomEaselJsConductor({
            gridTarget: document.getElementById('grid'),
            itemsTarget: document.getElementById('items'),
            image: preload.getResult('cell'),
            resolve(src) {
                return preload.getResult(src);
            },
            offsetPivot: 'bottom-right',
        });

        window.iso = new IsoDom(conductor, {
            debug: true,
            columns: 100,
            rows: 100,
            cellSize: [148, 88],
            items: {
                desk1: {
                    orientation: IsoDom.ORIENTATION_SE,
                    size: [2, 2],
                    images: {
                        [IsoDom.ORIENTATION_NW]: { url: 'desk1-1', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_NE]: { url: 'desk1-2', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_SE]: { url: 'desk1-3', offset: { top: 0, left: 0 } },
                        [IsoDom.ORIENTATION_SW]: { url: 'desk1-4', offset: { top: 103, left: 39 } },
                    },
                },
                meeting_table1: {
                    orientation: IsoDom.ORIENTATION_SE,
                    size: [6, 3],
                    images: {
                        [IsoDom.ORIENTATION_NE]: { url: 'meeting_table1-1', offset: { top: -0, left: -0 } },
                        [IsoDom.ORIENTATION_NW]: { url: 'meeting_table1-2', offset: { top: -0, left: -0 } },
                        [IsoDom.ORIENTATION_SW]: { url: 'meeting_table1-4', offset: { top: 286, left: 379 } },
                        [IsoDom.ORIENTATION_SE]: { url: 'meeting_table1-3', offset: { top: -0, left: -0 } },
                    },
                },
            },
            events: {
                cellCreated(cell) {
                    cell.meta.displayObject.addEventListener('mouseover', () => {
                        console.log('cell: mouseover');
                        if (moving) {
                            iso.conductor.updateItemPosition(moving, cell);
                        }
                    });
                    cell.meta.displayObject.addEventListener('click', () => {
                        console.log('cell: click');
                        if (moving) {
                            moving.iso.moveItem(moving, cell.x, cell.y);
                            moving.iso.draw();
                            moving.iso.conductor.config.itemsTarget.style.pointerEvents = '';
                            moving.iso.conductor.itemsStage.mouseEnabled = true;
                            moving = null;
                        }
                    });
                },

                itemAdded(item) {
                    const sprite = new createjs.SpriteSheet({
                        images: [preload.getResult('coin-sprite')],
                        frames: {
                            width: 57.14285714285714,
                            height: 57,
                        },
                        animations: {
                            spin: {
                                frames: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13],
                                speed: 0.35,
                            },
                        },
                    });
                    const animation = new createjs.Sprite(sprite);
                    animation.gotoAndPlay('spin');
                    item.meta.displayObject.addChild(animation);

                    item.meta.displayObject.scale = 0.55;
                    item.meta.displayObject.addEventListener('mouseover', () => {
                        console.log('item: mouseover');
                        if (debug) {
                            return;
                        }

                        item.meta.displayObject.children[0].filters = [
                            new createjs.ColorFilter(1, 1, 1, 1, 10, 10, 10, 0),
                        ];
                        item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                    });
                    item.meta.displayObject.addEventListener('mouseout', () => {
                        console.log('item: mouseclick');
                        if (debug) {
                            return;
                        }

                        item.meta.displayObject.children[0].filters = [
                            new createjs.ColorFilter(1, 1, 1, 1, 0, 0, 0, 0),
                        ];
                        item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                    });
                    item.meta.displayObject.addEventListener('click', (e) => {
                        console.log('item: click');
                        if (e.nativeEvent.button === 0) {
                            item.iso.conductor.config.itemsTarget.style.pointerEvents = 'none';
                            item.iso.conductor.itemsStage.mouseEnabled = false;
                            moving = item;
                        } else if (e.nativeEvent.button === 2) {
                            item.iso.conductor.config.itemsTarget.style.pointerEvents = 'none';
                            item.meta.displayObject.children[0].filters = [
                                new createjs.ColorFilter(1, 1, 1, 1, 100, 0, 0, 100),
                            ];
                            item.meta.displayObject.children[0].cache(0, 0, item.meta.displayObject.children[0].image.width, item.meta.displayObject.children[0].image.height);
                            debug = item;
                            const imageOffset = item.image().offset;
                            debugStart = { top: Number(item.meta.displayObject.y) - imageOffset.top, left: Number(item.meta.displayObject.x) - imageOffset.left };
                        }
                    });
                },
            },
        });

        //iso.conductor.gridStage.enableMouseOver(20);
        iso.conductor.itemsStage.enableMouseOver(20);

        iso.conductor.gridStage.scale = 0.2;
        iso.conductor.itemsStage.scale = 0.2;

        for (let row = 0; row < iso.config.rows-3; row = row+4) {
            for (let col = 0; col < iso.config.columns-3; col = col+4) {
                iso.addItem('desk1', col, row, { orientation: IsoDom.ORIENTATION_SW });
            }
        }

        // add a text object to output the current FPS:
        iso.fpsLabel = new createjs.Text("-- fps", "bold 60px Arial", "#000");
        iso.conductor.itemsStage.addChild(iso.fpsLabel);
        iso.fpsLabel.x = 10;
        iso.fpsLabel.y = 20;
        iso.fpsLabel.cache(0,0, 500, 500);

        /*iso.addItem('desk1', 0, 0, { orientation: IsoDom.ORIENTATION_SW });
        iso.addItem('meeting_table1', 0, 2, { orientation: IsoDom.ORIENTATION_SW });
        iso.addItem('meeting_table1', 0, 5, { orientation: IsoDom.ORIENTATION_SW });*/
        iso.draw();

        debug = true;
        document.addEventListener('keydown', (e) => {
            if (!debug) {
                return;
            }

            let mod = 1;
            if (e.shiftKey) {
                mod = 10;
            }

            let wasdStepSize = 10;

            switch (e.code) {
                case 'ArrowUp':
                    debug.meta.displayObject.y -= mod;
                    e.preventDefault();
                    break;

                case 'ArrowDown':
                    debug.meta.displayObject.y += mod;
                    e.preventDefault();
                    break;

                case 'ArrowLeft':
                    debug.meta.displayObject.x -= mod;
                    e.preventDefault();
                    break;

                case 'ArrowRight':
                    debug.meta.displayObject.x += mod;
                    e.preventDefault();
                    break;

                case 'Enter':
                    const pivots = iso.conductor.config.offsetPivot.split('-');
                    const output = {
                        top: debugStart.top - Number(debug.meta.displayObject.y),
                        left: debugStart.left - Number(debug.meta.displayObject.x),
                    };
                    if (pivots.includes('bottom')) {
                        output.top *= -1;
                    }
                    if (pivots.includes('right')) {
                        output.left *= -1;
                    }
                    console.log(debug.orientation, output);
                    debug.meta.displayObject.filters = [];
                    debug.meta.displayObject.cache(0, 0, debug.meta.displayObject.image.width, debug.meta.displayObject.image.height);
                    debug = null;
                    debugStart = null;
                    iso.draw();
                    iso.conductor.config.itemsTarget.style.pointerEvents = '';
                    e.preventDefault();
                    break;
                case 'KeyW':
                    iso.conductor.itemsStage.y += wasdStepSize;
                    iso.conductor.gridStage.y += wasdStepSize;
                    break;
                case 'KeyA':
                    iso.conductor.itemsStage.x += wasdStepSize;
                    iso.conductor.gridStage.x += wasdStepSize;
                    break;
                case 'KeyS':
                    iso.conductor.itemsStage.y -= wasdStepSize;
                    iso.conductor.gridStage.y -= wasdStepSize;
                    break;
                case 'KeyD':
                    iso.conductor.itemsStage.x -= wasdStepSize;
                    iso.conductor.gridStage.x -= wasdStepSize;
                    break;
            }

            // iso.conductor.itemsStage.update();
        });
    });
    preload.loadManifest([
        { src: 'assets/cell.png', id: 'cell' },
        { src: 'assets/coin-sprite.png', id: 'coin-sprite' },
        { src: 'assets/desk1-1.png', id: 'desk1-1' },
        { src: 'assets/desk1-2.png', id: 'desk1-2' },
        { src: 'assets/desk1-3.png', id: 'desk1-3' },
        { src: 'assets/desk1-4.png', id: 'desk1-4' },
        { src: 'assets/meeting_table1-1.png', id: 'meeting_table1-1' },
        { src: 'assets/meeting_table1-2.png', id: 'meeting_table1-2' },
        { src: 'assets/meeting_table1-3.png', id: 'meeting_table1-3' },
        { src: 'assets/meeting_table1-4.png', id: 'meeting_table1-4' },
    ]);
</script>
</body>
</html>
